{
	"templateName": "synthesys-batch-ingestion",
	"mappings": {
		"kbName": "",
		"input": "",
		"cdh4": "true",
		"entitiesTable": "false",
		"hive": "false",
		"hiveWarehouse" : "/user/hive/warehouse",
		"hiveSetupScript": "./views/defaultHiveImpala/hiveImpalaSetup.sh"
	},
	"resources": {
		"kb": "/kb/$kbName",
		"rivulet": "/process/$rivuletId",
		"frequencies": "/process/$frequenciesId",
		"resonance": "/process/$resonanceId",
		"associativenet": "/process/$associativenetId",
		"knowledgeobjects": "/process/$knowledgeObjectsId"
	},
	"conditionalAction": [
		{
			"condition": "mappings.processType == null",
			"endpointAction": {
				"uri": "/app",
				"verb": "GET",
				"entity": {}
			},
			"responseStatements": [
				"mappings.processType=mappings.cdh4=='true' ? 'oozie-cdh4' : 'oozie'"
			]
		},
		{
			"condition": "mappings.processType != null && mappings.kbName != null && mappings.rivuletId == null && !mappings.errorMessage",
			"endpointAction": {
				"uri": "/process?expandErrors=true",
				"verb": "POST",
				"entity": {
					"application": "rivulet",
					"processType": "$processType",
					"kb": "$kbName",
					"invocationConfig": {
						"input_rawText": "$input"
					}
				}
			},
			"responseStatements": ["mappings.rivuletId=response.id",
			                       "mappings.errorDetails=response.errorDetails",
			                       "mappings.errorMessage=response.errorMessage"]
		},
		{
			"condition": "mappings.frequenciesId == null && now.rivulet?.status == 'COMPLETE' && !mappings.errorMessage",
			"endpointAction": {
				"uri": "/process",
				"verb": "POST",
				"entity": {
					"application": "frequencies",
					"processType": "$processType",
					"kb": "$kbName"
				}
			},
			"responseStatements": ["mappings.frequenciesId=response.id",
			                       "mappings.errorDetails=response.errorDetails",
			                       "mappings.errorMessage=response.errorMessage"]
		},
		{
			"condition": "mappings.resonanceId == null && now.rivulet?.status == 'COMPLETE' && !mappings.errorMessage",
			"endpointAction": {
				"uri": "/process",
				"verb": "POST",
				"entity": {
					"application": "resonance",
					"processType": "$processType",
					"kb": "$kbName"
				}
			},
			"responseStatements": ["mappings.resonanceId=response.id",
			                       "mappings.errorDetails=response.errorDetails",
			                       "mappings.errorMessage=response.errorMessage"]
		},
		{
			"condition": "mappings.knowledgeObjectsId == null && now.rivulet?.status == 'COMPLETE' && now.resonance?.status == 'COMPLETE' && !mappings.errorMessage",
			"endpointAction": {
				"uri": "/process",
				"verb": "POST",
				"entity": {
					"application": "knowledgeobjects",
					"processType": "$processType",
					"kb": "$kbName",
                                        "invocationConfig": {
                                            "entitiesTable":"$entitiesTable"
                                        }
				}
			},
			"responseStatements": ["mappings.knowledgeObjectsId=response.id",
			                       "mappings.errorDetails=response.errorDetails",
			                       "mappings.errorMessage=response.errorMessage"]
		},
		{
			"condition": "mappings.hive == 'true' && mappings.hiveSetupScriptExitValue == null && now.knowledgeobjects?.status == 'COMPLETE' && !mappings.errorMessage",
			"endpointAction": {
				"uri": "/app",
				"verb": "GET",
				"entity": {}
			},
			"responseStatements": ["mappings.hiveSetupScriptExitValue=[mappings.hiveSetupScript, mappings.kbName, mappings.hiveWarehouse].execute().exitValue()"]
		},
		{
			"condition": "mappings.associativenetId == null && now.frequencies?.status == 'COMPLETE' && !mappings.errorMessage",
			"endpointAction": {
				"uri": "/process",
				"verb": "POST",
				"entity": {
					"application": "associativenet",
					"processType": "$processType",
					"kb": "$kbName"
				}
			},
			"responseStatements": ["mappings.associativenetId=response.id",
			                       "mappings.errorDetails=response.errorDetails",
			                       "mappings.errorMessage=response.errorMessage"]
		},
		{
			"condition": "now.rivulet?.status == 'FAILED' || now.frequencies?.status == 'FAILED' || now.resonance?.status == 'FAILED' || now.associativenet?.status == 'FAILED' || now.knowledgeobjects?.status == 'FAILED' || mappings.errorMessage",
			"endpointAction": {
				"uri": "/scheduler/schedule/$id",
				"verb": "PATCH",
				"entity": {
					"status": "STOPPING"
				}
			}
		},
		{
			"condition": "now.rivulet?.status == 'COMPLETE' && now.frequencies?.status == 'COMPLETE' && now.resonance?.status == 'COMPLETE' && now.associativenet?.status == 'COMPLETE' && now.knowledgeobjects?.status == 'COMPLETE' && (mappings.hive == 'false' || mappings.hiveSetupScriptExitValue != null)",
			"endpointAction": {
				"uri": "/scheduler/schedule/$id",
				"verb": "PATCH",
				"entity": {
					"status": "STOPPING"
				}
			}
		}
	]
}
