import errno
import logging
import os
import sys

def init(config):
    fab_log = get_logger()
    fab_log.handlers = []
    fab_format = logging.Formatter(config['format'], datefmt=config['datefmt'])

    logfile = config['path']
    try:
        os.makedirs(os.path.dirname(logfile))
    except OSError, e:
        if e.errno != errno.EEXIST:
            raise
    sys.stderr.write("Fabric output: %s\n" % logfile)

    fab_handler = logging.FileHandler(logfile)
    fab_handler.setFormatter(fab_format)
    fab_log.addHandler(fab_handler)

    if config.get('to_stream'):
        stream_handler = logging.StreamHandler()
        stream_handler.setFormatter(fab_format)
        fab_log.addHandler(stream_handler)

    fab_log.propagate = config.get('propogate', False)
    fab_log.setLevel(config['level'])


def get_logger():
    return logging.getLogger('qatp.fabric')
